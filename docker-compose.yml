services:
  agentlens:
    # image: pazgaz/agentlens:latest  # uncomment for Docker Hub, comment build:
    build:
      context: ../agentlens
      dockerfile: Dockerfile
    container_name: agentlens
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - AUTH_DISABLED=true
      - DB_PATH=/app/data/agentlens.db
      - AGENTGATE_URL=http://agentgate:3002
      - LORE_ENABLED=true
      - LORE_MODE=remote
      - LORE_API_URL=http://lore:8765
      - LORE_API_KEY=lore_sk_a01079a5b4b6c6f194b6419a69ff92dd
      - MESH_ENABLED=true
      - MESH_URL=http://mesh:8766
    volumes:
      - agentlens-data:/app/data
    networks:
      - agentkit
    restart: unless-stopped
    depends_on:
      lore:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256M

  agentgate:
    image: pazgaz/agentgate:latest
    # build:
    #   context: ../agentgate
    #   dockerfile: Dockerfile
    container_name: agentgate
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
      - NODE_ENV=production
      - LOG_FORMAT=json
      - ADMIN_API_KEY=agentkit-local-dev-key-1234
      - JWT_SECRET=agentkit-local-dev-jwt-secret-1234567890abcdef
      - AGENTLENS_URL=http://agentlens:3000
    volumes:
      - agentgate-data:/app/data
    networks:
      - agentkit
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M

  lore:
    build:
      context: ../lore
      dockerfile: Dockerfile.server
    container_name: lore
    ports:
      - "8765:8765"
    environment:
      - DATABASE_URL=postgresql://lore:lore@lore-db:5432/lore
    volumes:
      - lore-data:/app/data
    networks:
      - agentkit
    restart: unless-stopped
    depends_on:
      lore-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8765/health')\""]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M

  lore-db:
    image: pgvector/pgvector:pg16
    container_name: lore-db
    environment:
      - POSTGRES_USER=lore
      - POSTGRES_PASSWORD=lore
      - POSTGRES_DB=lore
    volumes:
      - lore-db-data:/var/lib/postgresql/data
    networks:
      - agentkit
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lore"]
      interval: 5s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 128M

  mesh:
    build:
      context: ../agentkit-mesh
      dockerfile: Dockerfile
    container_name: mesh
    ports:
      - "8766:8766"
    environment:
      - DB_PATH=/app/data/mesh.db
      - NODE_ENV=production
    volumes:
      - mesh-data:/app/data
    networks:
      - agentkit
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8766/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M

volumes:
  agentlens-data:
  agentgate-data:
  lore-data:
  lore-db-data:
  mesh-data:

networks:
  agentkit:
    driver: bridge
